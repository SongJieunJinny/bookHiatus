<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
			"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bookGap.mapper.commentMapper"> 

	<!-- =================== ëŒ“ê¸€ ì¡°íšŒ (N+1 ë¬¸ì œ í•´ê²°) =================== -->
	<select id="getCommentListWithDetails" parameterType="map" resultType="com.bookGap.vo.CommentVO">
	  SELECT c.COMMENT_NO                             AS commentNo,
		       c.USER_ID                                AS userId,
		       c.COMMENT_CONTENT                        AS commentContent,
		       DATE_FORMAT(c.COMMENT_RDATE, '%Y.%m.%d') AS formattedCommentRdate,
		       cr.RATING                                AS commentRating,
		       (SELECT COUNT(*) > 0 FROM love l WHERE l.COMMENT_NO = c.COMMENT_NO AND l.USER_ID = #{loginUserId}) AS lovedByLoginUser
	    FROM comment c
 LEFT JOIN comment_rating cr ON c.COMMENT_NO = cr.COMMENT_NO AND cr.USER_ID = #{loginUserId}
	   WHERE c.isbn = #{isbn} AND c.COMMENT_STATE = '1'
  ORDER BY c.COMMENT_NO DESC
	   LIMIT #{start}, #{perPage}
	</select>
	
	<select id="selectTotal" parameterType="String" resultType="int">
		SELECT COUNT(*)
		  FROM COMMENT  
     WHERE isbn = #{isbn} 
       AND COMMENT_STATE = '1'
	</select>
	
	<!-- ðŸ”» useGeneratedKeysëŠ” í•„ìˆ˜! ðŸ”» -->
	<insert id="insert" parameterType="com.bookGap.vo.CommentVO" useGeneratedKeys="true" keyProperty="commentNo">
	  INSERT INTO COMMENT (USER_ID,
	  										 isbn,
	  										 BOOK_NO,
	  										 COMMENT_CONTENT,
	  										 COMMENT_RDATE,
	  										 COMMENT_STATE)
	  						VALUES (#{userId},
	  									  #{isbn},
	  									  #{bookNo},
	  									  #{commentContent},
	  									  NOW(),
	  									  '1')
	</insert>
	
	<select id="selectOne" parameterType="int" resultType="com.bookGap.vo.CommentVO">
	  SELECT COMMENT_NO    AS commentNo,  
           USER_ID       AS userId
      FROM COMMENT  
     WHERE COMMENT_NO = #{commentNo}
	</select>
	
	<update id="update" parameterType="com.bookGap.vo.CommentVO">
    UPDATE COMMENT
			 SET COMMENT_CONTENT = #{commentContent}
     WHERE COMMENT_NO = #{commentNo}
       AND USER_ID = #{userId}
  </update>
	
	<update id="changeState" parameterType="int">
		UPDATE COMMENT
		   SET COMMENT_STATE = '2'
		 WHERE COMMENT_NO = #{commentNo}
	</update>
	
	
	
	
	
	
	
	
	
	
	
	
	
	<select id="getBookWriterId" parameterType="String" resultType="String">
  	SELECT USER_ID FROM BOOK WHERE isbn = #{isbn}
	</select>
	
	<select id="selectIsbn" parameterType="String" resultType="com.bookGap.vo.CommentVO">
  	SELECT USER_ID         AS userId,
	         COMMENT_CONTENT AS commentContent,
	         isbn
     	FROM COMMENT 
     WHERE COMMENT_STATE = 1
       AND isbn = #{isbn}
	</select>
	
	<update id="adminDeleteComment" parameterType="int">
    UPDATE COMMENT
       SET COMMENT_STATE = 2
     WHERE COMMENT_NO = #{commentNo}
	</update>

</mapper>